

- 프록시와 즉시로딩, 지연로딩
- 영속성 전이와 고아 객체



## 프록시
- 엔티티를 조회할 때 연관된 엔티티들이 항상 사용되는 것은 아님
- 연관관계가 맺어진 엔티티를 선택적으로 가져오고자 할 때 JPA는 지연로딩이라는 방법을 제공함
	- 데이터가 필요한 시점까지 데이터를 지연시켜 가져오는 방식
	- 지연 로딩 기능을 사용하려면 실제 엔티티 객체 대신 데이터베이스를 조회할 수 있는 가짜 객체 즉 프록시 객체가 필요함
- JPA에서 식별자로 엔티티를 조회할 때는 `EntityManager.find`를 사용함
	- 영속성 컨텍스트에 엔티티가 없으면 데이터베이스를 조회함
- 조회한 엔티티를 실제 사용시점까지 조회를 미루고 싶으면 `EntityManager.getReference`메서드를 사용
- JPA는 데이터베이스를 조회하지 않고 실제 엔티티 객체도 생성하지 않음
![[Pasted image 20240603212858.png]]
- 사용하는 입장에서는 사용하는 객체가 프록시 객체인지 아닌지는 크게 중요하지 않습니다.
- 프록시 객체의 동작 방식은 프록시 객체가 원본 객체에 대한 참조를 가지고 있으며 객체의 메서드를 호출하면 실제 객체의 메서드를 호출하는 방식으로 동작함
- 프록시의 특징
	- 프록시 객체는 처음 사용할 때 한 번만 초기화된다.
	- 프록시 객체를 초기화한다고 프록시 객체가 실제 엔티티로 바뀌는 것은 아님
	- 프록시 객체는 원본 엔티티를 상속받은 객체이므로 타입 체크 시에 주의해서 사용
	- 영속성 컨텍스트에 찾는 엔티티가 이미 있으면 데이터베이스를 조회할 필요가 없기에 실제 엔티티를 반환함
- 프록시의 식별
	- 엔티티를 프록시로 조회할 때 식별자(PK) 값을 파라미터로 전달하는데 프록시 객체는 이 식별자 값을 보관한다.


## 즉시 로딩과 지연 로딩
프록시 객체는 주로 연관된 엔티티를 지연 로딩할 때 사용합니다.

엔티티를 조회할 때 두 가지 방법으로 조회할 수 있습니다. 
- 즉시로딩 
	- 즉시로딩은 엔티티를 조회할 때 연관된 앤티티도 함께 조회하는 방식 
	- `ManyToOne(fetch=FetchType.EAGER)`을 사용
- 지연로딩
	- 연관된 엔티티를 실제 사용할 떄 조회하는 방식
	- `ManyToOne(fetch=FetchType.LAZY)`를 사용

> [!NOTE] 참고
>  
>  Nullable 설정에 따른 조인 전략이 달라질 수 있습니다.
>  
>  @JoinColumn(nullable=true) : Null허용, 외부 조인 사용
>  @JoinColumn(nullable=false) : Null 허용하지 않음, 내부 조인 사용
>  

## 영속성 전이: CASCADE
- 특정 엔티티를 영속 상태로 만들 때 연관된 엔티티도 함께 영속 상태로 만들고 싶으면 영속성 전이 기능을 사용해야 합니다. 

- 저장
	- 