
# 전문 검색

- MySQL에서 B-Tree 자료 구조를 사용해 짧은 단어를 검색할 수 있지만 용량이 큰 문서를 단어 수준으로 잘개 쪼개어 문서 검색을 하게 해주는 전문 검색(Full-text Search)라고 합니다.
- 단 전문 검색은 형태소를 찾고 인덱싱하는 방법은 서구권 언언에는 적합하지만 한국어에는 적합하지 않습니다. 
- 이를 극복하기 위해 특정 길이의 조각으로 인덱싱하는 N-gram 파서가 추가됐습니다.

## 전문 검색 인덱스의 생성과 검색 
- MySQL 서버에서는 형태소 분석, n-gram 파서 2가지 알고리즘을 이용해 인덱싱할 토큰을 분리합니다. 
- 형태소 분석은 문장의 공백과 같은 띄어쓰기로 단어를 분리하고 조사를 제거해 명사 또는 어근을 찾아 인덱싱하는 알고리즘
- MySQL 서버에는 해당 기능은 구현돼 있지 않습니다.
- n-gram은 문장 자체에 대한 이해 없이 공백과 같은 띄어쓰기 단위로 단어를 분리하고, 그 단어를 단순히 주어진 길이로 쪼개서 인덱싱 하는 알고리즘


### n-gram
- n-gram의 n은 숫자 값을 의미함
- ngram_token_size 시스템 변수로 n값을 조절할 수 있음 (초기 값은 2, 1~10 사이의 숫자)
- n의 값에 따라 다르게 부름
	- n == 1 : uni-Gram
	- n == 2: bi-gram
	- n == 3: tri-gram
	- n이 4보다 큰 경우도 있지만 검색어의 길이 제약이 생기기 때문에 bi-gram, tri-gram을 사용
- ngram_token_size 시스템 변수는 읽기 전용 값이기 때문에 MySQL 서버의 설정 파일을 이용해 서버가 시작될 때 변경가능합니다. 
- 테이블의 전문 검색 인덱스를 생성할 때 `WITH PRASER ngram` 옵션을 추가해야만 n-gram 토큰 파서를 사용해서 토큰을 생성할 수 있음
- 추가 하지 않는 경우 기본 파서(공백과 같은 구분자를 기준으로 단어 분리)를 사용해서 전문 인덱스를 생성

(실제 사용 예시는 214p 참고)

- bi-gram과 tri-gram 전문 검색 인덱스에는 2가지 규칙이 있습니다.
	1. 검색어의 길이가 ngram_token_size보다 작은 경우는 검색 불가능합니다.
	2. 검색어의 길이가 ngram_token_size보다 크거나 같은 경우 검색 가능합니다. 
- ngram_token_size가 2인 경우 2글자 이상의 검자는 가능하지만 1글자 검색어는 결과로 가져오지 못함
- n-gram 전문 검색 인덱스의 특징은 검색어가 단어의 시작 부분이 아닌, 단어의 중간혹은 마지막 부분이어도 n-gram이 검색할 수 있음


### 전문 검색 쿼리 모두
- MySQL 서버의 전문검색 쿼리는 자연어 검색 모드와 불리언 검색 모드를 지원합니다. 
	- 기본 검색 모드는 자연어 검색 보드를 사용

#### 자연어 검색 
- 자연어 검색은 검색어에 포함된 단어들이 존재하는 결과를 가져옵니다. 
- MySQL 서버의 자연어 검색은 제시된 단어들을 많이 가지고 있는 순서대로 정렬해서 결과를 반환한다.
![[Pasted image 20240311183130.png]]
- 전문 검색 쿼리의 검색어에는 문장을 그대로 검색어로 사용하는 `Pharse search`기능이 있습니다.
![[Pasted image 20240311183328.png]]
- `Pharse search` 기능은 검색어를 구분자 단어로 분리하고 다시 n-gram 파서로 토큰을 생성한 후 각 토큰에 대해 일치하는 단어의 개수를 확인해서 일치율을 계산합니다. 
- 검색어에 사용된 모든 단어가 포함된 레코드 뿐만 아니라 일부만 포함하는 결과도 가져옵니다.
-  (주의) 검색어가 단일 단어 또는 문장인 경우 문장 기호는 무시됩니다. 

#### 불리언 검색
-  불리언 검색은 쿼리에 사용되는 검색어의 존재 여부에 대한 논리적인 연산이 가능합니다.
![[Pasted image 20240311183811.png]]
- MySQL은 포함되지만 manual은 포함하지 않는 레코드를 검색하는 쿼리 
- + 표시를 가진 검색 단어는 전문 검색 인덱스에 포함된 단어
- - 표시를 가진 검색 단어는 전문 검색 인덱스 컬럼에 포함돼 있지 않은 단어
- * 표시로 시작하는 단어를 포함하는 단어
- 표시가 없는 경우 마찬가지로 특정 단어로 시작하는 단어 (와일드 카드와 동일함)



#### 검색어 확장
- 검색어 확장은 사용자가 쿼리에 사용한 검색어로 검색된 결과에서 공통으로 발견된 단어들을 모아 재검색하는 방식입니다.
![[Pasted image 20240311184203.png]]
- 이처럼 Oracle MySQL이 포함된 단어도 검색하려면 아래와 같이 작성하면 됩니다.
- ![[Pasted image 20240311184222.png]]

### 전문 검색 인덱스 디버깅
- 다양한 이우로 MySQL 서버의 전문 검색 쿼리가 원하는 결과를 만들어내지 못하는 경우 가 있으며 오류의 원인을 찾아내기가 쉽지 않습니다.
- MySQL에서는 전문 검색 쿼리 오류의 원인을 쉽게 찾을 수 있도록 디버깅 기능을 제공합니다.

- `information_schema.innodb_ft_config`: 전문 검색 인덱스의 설정 내용을 보여줌
- `information_schema.innodb_ft_index_table`: 전문 검색 인덱스가 가지고 있는 인덱스 엔트리의 목록을 보여줌
	- 전문 검색 인덱스의 각 엔트리는 토큰들이 어떤 레코드에 몇 번 사용됐는지, 레코드별로 문자 위치가 어디인지 등의 정보를 관리함
- `information_schema.innodb_ft_index_cache`: 테이블에 레코드가 새롭게 insert되면 MysQL 서버는 전문 검색 인덱스를 위한 토큰을 분리해서 디스크로 저장하지 않고 메모리 저장하는 임시 공간이다. 
- `information_schema.innodb_ft_deleted, innodb_ft_being_deleted`: 어떤 레코드가 삭제 됐는지, 전문 검색 인덱스에서 어떤 레코드가 삭제되고 있는지 보여준다.


# 공간검색

## 용어 설명

- `OGC`: 위치기반 데이터에 대한 표준을 수립하는 단체
- `OpenGIS`: OGC에서 제정한 지리 정보 시스템 표준
- `SRS(Spatial Reference System)`: 공간 참조 시스템, 좌표계로 부르며 GCS, PCS로 구분
	- 위도와 경도와 같이 각도 단위로 표현
- `GCS(Geographic Coordinate System)`: 지구 구체상의 특정 위치나 공간을 표현하는 좌표계, 구체 표면의 특정 위치를 정의하는데 사용
- `PCS(Projected Coordinate System)`: 구체 형태의 지구를 종이지도와 같은 평면으로 투영시킨 좌표계, GCS위치 데이터를 2차원 평면인 종이에 정의하는데 사용
- `SRID(Spatial Reference Id)`: SRS를 지칭하는 고유 번호
- `SRS-ID`: SRID와 동의어, 단 규어번호를 저장할 때 사용하는 이름, 함수의 인자나 식별자는 SRID
- `WKT(Well-Known Text format)`: 사람 눈으로 쉽게 확인할 수 있는 텍스트 포맷
- `WKB(Well-Known Binary format)`: 컴퓨터에 저장할 수 있는 형태의 이진 포맷의 저장 표준
- `MBR(Minimum Bounding Rectangle)`: 도형을 감싸는 최소의 사각 상자(고간 인덱스로 사용)
- `R-Tree`: MBR의 포함관계를 이용해서 만들어진 인덱스


## SRS(Sparitial Reference System)

- SRS는 GSC(지리 좌표계), PCS(투영 좌표계)로 구분됩니다. 
- MySQL 서버에서 지원하는 SRS는 5000여 개가 넘음
- information_schema 데이터베이스의 ST_SPATIAL_REFERENCE_SYSTEM 테이블을 통해 지원하는 SRS를 확인할 수 있음

![[Pasted image 20240310233419.png | 600]]

- SRS_ID 컬럼은 해당 좌표계를 지칭하는 고유번호를 의미함, 
- DEFINITION 컬럼은 해당 좌표계가 어떤 좌표계인지에 대한 정의를 표현, 주로 컬럼에 데이터를 저장하거나 검색할 때 사용하기에 어떤 SRS를 사용하는지 알아야 함

![[Pasted image 20240310233717.png]]

- WGS 84 좌표계를 사용하며 고유번호는 4326
- 값의 단위는 DEGREE로 저장
- 참고: DEFINITION 컬럼의 값은 항상 GEOGCS또는 PROJCS로 시작
	- GEOGCS -> GCS, PROJCS -> PCS를 의미
- MySQL 서버가 지원하는 지리 좌표계는 약 483개, 투영 좌표계는 약 4668개를 지원함
- 투영좌표계가 지리좌표계보다 많은 이유는 특정 지역을 위한 좌표계는 평변으로 투영해서 좌표를 관리해도 오차가 발생하지 않음
- AXIS는 위도, 경도 순서로 나열
- 실제로 위도, 경도로 특정 지역을 표현할 때 Point(위도 경도)로 표현함
- AXIS 나열된 순서로 X축,Y축을 표현 
- ST_X는 위도, ST_Y는 경도



아래는 SRS_ID가 3857인 투영 좌표계의 상세 정의
![[Pasted image 20240311100330.png]]

- 좌표계의 이름은 WGS 84
- 단 값의 단위는 미터(meter)
- 해당 공간 좌표계는 웹 페이지에서 지도로 보여주기 위한 투영 좌표계
- 주로 구글, 오픈 스트맅트 맵, 웹 기반 지도 프로젝트에 사용
- SRID=3857의 DEFINITION 컬럼에서 AXIS을 보면 SRID=4326과는 반대로 POINT(경도 위도) 순서로 명시


- MySQL 서버의 공간 데이터를 저장할 때 별도의 SRID를 지정하지 않는 경우 SRID가 0인 평면 좌표계를 사용함

> ℹ 참고
> 
> MySQL에서 공간 데이터를 저장할 때 SRID를 지정하는 것이 좋을까요?
> 
> 문자열 타입의 콜레이션을 다른 방식으로 정의할 수 있는 것 처럼 상황에 따라 필요한 것을 사용하면 된다.
> 단 별도의 SRID를 지정하면 실제 지구상의 좌표를 관리하는 데 있어 MySQL 서버가 지원하는 기능을 제대로 활용하지 못하게 된다.     



### Point(0,0) 과 Point(1,1)  사이의 거리 계산하기
> 선행 지식
> 
> ST_PointFromText(): MySQL 서버 공간 데이터(point)를 생성하는 함수, 첫 파라미터가 점의 위치, 두 번째 파리멑 공관 좌표계의 아이디
> 
> ex) ST_PointFromText(점의 위치, SRSID)


(평면 좌표계(SRID=0) 을 사용한 공간 데이터)
![[Pasted image 20240311101718.png]]
- SRID가 0으로 ST_Distanace() 함수의 결과는 아무런 단위가 없고, 단순히  피타고라스의 정리에 의한 수식으로 계산도니 거리 값입니다.
- km, meter 단위로 환샨할 수 없는 수치


(웹 기반 지도 좌표계(SRID=3857)을 사용한 공간 데이터)
![[Pasted image 20240311101945.png]]

(WGS 지리 좌표계(SRID=4326)을 사용한 공간 데이터)
![[Pasted image 20240311102105.png]]
- 2, 3번 째 예시는 SRID가 0이 아닌 값으로 ST_DISTANCE는 단위 값을 가짐, (미터, meter)
- 1,2번 의 값이 같은 이유는 구체에 대한 고리 없이 평면에서 거리를 계산했기 때문 
- SRID, SRID 가 0인 경우에는 MySQL서버의 공간 함수들이 실제 데이터의 SRID를 알 수 없기 때문에 사용자가 원하는 값을 계산하지 못할 수 있음


### 주의
- MySQL 8.0에서 SRID를 별도로 명시하지 않거나 SRID를 0으로 지정한 공간 데이터라고 해서 km, meter 단위의 거리 계산을 못하는 것은 아님
- 이는 MySQL 서버가 필요한 값을 계산하지 못한다는 것을 의미함
- 예시로 SRID가 0인 경우 수동으로 데이터를 WGS84 좌표계로 변환해서 거리 계산을 하거나 별도의 환산 작업을 거쳐야 함


## 투영 좌표계와 평면 좌표계

- 지구 구체 전체 또는 일부를 평면으로 투영해서 표현한 좌표계를 투영 좌표계라고 합니다.
- SRID=0인 좌표계도 평면 좌표계지만 투영 좌표계는 아닙니다.
- SRID=0인 좌표계는 단위를 가지지 않습니다.
- X, Y축의 값이 제한을 가지지 않기 때문에 무한 평면 좌표계라고도 불립니다.
- SRID=0 좌표계와 대표 적인 투영 좌표계인 SRID=3857은 값의 단위 그리고 최대 최솟값을 제외하면 거의 차이가 없다.
- SRID=0은 평면 좌표계지만 SRID=3857은 투영좌표계로 X,Y축을 미터(meter)로 표현한다. 

![[Pasted image 20240311122512.png]]

- MySQL 서버는 SRID를 지정하지 않으면 기본값 0을 가짐
- 평면 좌표계와 투영 좌표계에서 거리 계산은 피타고라스 정리 수식에 의해서 좌표간의 거리가 계산됨
- 평면 좌표계에서 두 점 간의 거리는 아무런 단위를 가지지 않지만 투영 좌표계에서의 두 점 간의 거리는 투영 좌표계의 단위에 따라 결정됩니다.
- 평면 좌표계에서는 ST_PointFromText 함수를 이용해서 Point 문자열을 Geometry 타입 값으로 변환할 때 SRID를 설정하지 않아도 자동으로 SRID=0으로 설정됩니다.
- SRID=3857 투영 좌표계에서 ST_PointFromText 함수를 이용해서 Point 문자열을 Geomery 타입 값으로 변환할 때는 반드시 SRID인 3857을 명시적으로 설정해야 합니다.

![[Pasted image 20240311132012.png]]
- 예제에서 테이블을 생성하면서 평면 좌표계 테이블에서는 SRID를 0, 투영 좌표계 테이블에서는 SRID를 3857로 지정
- location 컬럼에 저장되는 값은 모두 평면 좌표계 또는 투영 좌표계를 사용하는 공간 데이터를 명시적으로 선언한 것

![[Pasted image 20240311132504.png]]
- 앞서 이야기 했듯 공간 SRID가 다른 경우 해당 데이터를 저장할 수 없습니다.

아래는 평면, 투영 좌표계 검색 쿼리 입니다.
(평면 좌표계)
![[Pasted image 20240311132745.png]]
![[Pasted image 20240311132825.png]]

투영 좌표계 검색
![[Pasted image 20240311133000.png]]

- 평면 좌표계, 투영 좌표계의 쿼리 결과는 이진 데이터로 조회됐는데 이는 MySQL 서버가 내부적으로 사용하는 이진 포맷(WBB 포맷의 공간 데이터)
 - MySQL서버 내부의 이진 데이터 포맷은 WKB 앞쪽에 SRID를 위한 4바이트 공간이 추가돼 있기 떄문에 wkb포맷과 파이를 보입니다. 
-  MySQL서버의 내부 이진 포맷을 편하게 보기위해 ST_AsText, ST-x, st_함수를 이용합니다

- 평면 좌표계와 투영 좌표계에서 두 점 간의 거리를 계산하면 단순 피타고리스의 정리에 의한 거리 계산입니다.
- 즉 투영 좌표계라  하더라도 지구 구체상의 실제 거리와는 오차가 있을 수 있습니다.

![[Pasted image 20240311134527.png]]

- 지구 구체상의 두 점 거리를 계산하기 위해 st_distance_sphere 함수를 사용할 수 있지만 SRID=4326과 같은 지리 좌표계에서만 사용 가능하다.


## 지리 좌표계

### 지리 좌표계 데이터 관리
- 지역의 위치 정보를 저장하기 위한 테이블을 생성, 공간 인덱스를 준비
- 공간 인덱스를 생성하는 컬럼은 반드시 not null이어야 함
- wgs84 좌표계(srid 4326)로 컬럼 정의
![[Pasted image 20240311134854.png | 600]]
![[Pasted image 20240311134931.png]]

- 공간 데이터를 검색하는 가장 일반적인 사용법은 특정 위치를 기준으로 반경 몇 km 이내의 데이터를 검색하는 작업
- 지리 좌표계에서 두 점의 거리는 st_distance_sphere 함수를 이용한다.
![[Pasted image 20240311135249.png]]
- 위 예제는 1km이내에 있는 레코드를검색하는 거리로 st_distance_sphere 함수로 두 윛간의 거리를 미터 단위로 값을 변환한다.

![[Pasted image 20240311141213.png]]
- 실행 계획에서 알 수 있듯 MySQL 서버는 풀 테이블 스캔을 이용해 2건을 검색했다. 다른 rdbms에서는 인덱스를 이용한 반경 검색이 가능하지만 mysql에서는 지원하지 앟는다.
- 그렇기에 MBR(Minimum Bounding Rectangle)을 이용해야 한다.
- MBR은 첫 번째 파라미터로 공간 데이터가 핑요하며 두 번째 파라미터는 공간 데이터에 포함되는지 체크하는 함수이다.

주의점 
- WGS 84공간 좌표계의 위치의 단위는 각도이기 때문에 검색 기준위치로 부터 상하좌우 1KM 떨어진 지점의 위치를 계산하기 위해서 1km 거리가 각도로는 얼마인지 계산해야 함
- 지구는 구면체이기 때문에 위도에 따라서 경도 1도에 해당하는 거리가 달라짐
![[Pasted image 20240311154442.png]]
위도와 경도에 따라 거리변화까지 고려해서 상하좌우 1km에 해당하는 경도 좌표를 계산하는 방법
![[Pasted image 20240311154528.png]]
![[Pasted image 20240311155644.png]]

(다시보기 쉽게 이해가 안가네;;)

111.32 경도 1도에 해당하는거리 표현한걸로 해당 계산식으로 1KM 반경의 원을 감싸는 직사각형 폴리곤 객체를 만들 수 있습니다 

![[Pasted image 20240312161407.png]]

- 여기서 st_contains 또는 st_within 함수를 이용하면 실제 반경 검색을 할 수 있습니다.
![[Pasted image 20240312161640.png]]
- 실제 실행 계획의 경우 range 접근 방식으로 읽음

여기서 참고할 것은 실제 사각형 내의 점들을 검색하기 떄문에 1km를 넘어서는 부분도 포함됩니다.
그렇기에 사각형은 반경에 제외되는 부분을 필터링 하기 위해서 MBR을 사각형이 아닌 16각형으로 생성하면 인덱스를 더 효율적으로 사용할 수 있습니다. 


### 지리 좌표계 주의사항 

- MySQL 서버의 SRS 관리 기능은 MySQL 8.0부터 도입된 것으로 아직 미숙한 부분이 많기에 정확성과 성능에 주의가 필요합니다. 
![[Pasted image 20240312161504.png]]
#### 지리 좌표계 정확성 주의사항 
- 지리 좌표계 (SRID=4326) 에서 st_contains 함수가 정확하지 않은 결과를 반환하기도 합니다.
![[Pasted image 20240311160259.png]]
-  책에서는 북국의 특정 지점이 경기도 지역 polygon에 포함되는 쿼리 결과가 반환된다고 합니다.
- 현재도 그대로 버그가 있으며사용에 주의해야합니다.
![[Pasted image 20240311160404.png]]
비교적 쉬운 해결책 폴리곤 중심 지점으로부터 특정 거리만큼 일치하는지 여부로 쉽게 해결할 수 있습니다


#### 성능 주의 사항
- 지리 좌표계 데이터의 경우 일반적으로 SRID 4326인 좌표계를 많이 사용합니다.
- st_contains 함수 등으로 포함 관계를 비교하는 경우 지리좌표계는 투영 좌표계보다는 느린 성능을 보입니다.

(실제 벤치마크 데이터가 없어서 못해본게 아쉽 )

### 좌표계 변환
