
## 문제점
바이너리 로그 포맷을 Row로 사용 중인 상태에서 Row 이미지를 조정했다고 하더라도 유입되는 DML 쿼리의 양이 많은 MySQL 서버에서는 바이너리 로그 파일의 크기가 커질 수밖에 없습니다. 

디스크 저장 공관과 네트워크 대역폭 사용량 절약을 위해 바이너리 로그 보관 주기를 더 짧게 선정하거나, 원격 스토리지 서버에 저장할 때 별도의 툴을 사용해 바이너리 로그 파일들을 압축한 뒤 전송하는 방법이 있다.

하지만 원격의 레플리카 서버로 바이너리 로그를 전송함에 따라 소비되는 네트워크 대역폭 사용량은 사용자가 줄일 수 없으며, 안정적인 복제와 신규 레플리카 서버 구축 등을 위해서는 바이너리 로그 보관 주기를 짧게 설정하는 것도 한계가 있습니다. 


## 해결책

MySQL 8.0.20 버전에서 ROW 포맷으로 기록되는 트랜잭션에 대해 트랜잭션에서 발생한 데이터를 압축해서 바이너리 로그에 기록할 수 있는 기능 도입


## 복제 과정
![[Pasted image 20240416105449.png]]
1. 트랜잭션에서 변경한 데이터들을 zstd 알고리즘을 사용해 압축
2. Transaction_payload_event라는 하나의 이벤트로 바이너리 로그에 기록
3. 압축된 트랜잭션 데이터가 레플리카 서버로 복제 (압축된 상태 유지)
4. 레플리카 서버의 [[../레플리케이션 IO 스레드|레플리케이션 IO 스레드]]로 압축된 상태 그대로 [[../릴레이 로그|릴레이 로그]]에 기록 


## 주의점
소스 서버에서 바이너리 로그 압축이 적용된 경우 레플리카 서버도 반드시 바이너리 로그 압축을 지원하는  MySQL 8.0.20이상의 버전을 사용해야 한다. 


## 사용 방법
- `binlog_transaction_compression` 시스템 변수를 통해 압축 기능 활성화
- `binlog_transaction level_zstd` 시스템 변수를 통해 zstd 알고리즘 레벨 설정

- `binlog_transaction_compression`: ON, OFF로 설정
- `binlog_transaction_compression_level_zstd`
		- 1~22까지 값을 지정
		- 기본 값은 3
		- 압축 레벨이 높을 수록 압축률 증가 
		- 단 CPU와 메모리 사용량, 처리 시간이 증가
		- ⚠ 압축률이 높다고 압축률이 좋은 것은 아님

### 압축 설정 시 주의/참고 
1. 바이너리 로그 트랜잭션 압축은 모든 경우에 대해 압축을 적용하지 않음
	 - [[../GTID|GTID]] 설정
	 - Statement 포맷으로 기록되는 트랜잭션 이벤트
	 - 그룹 복제에서 발생하는 View change 이벤트,  Heartbeat와 같은 제어 이벤트
	 - 복제 실패 및 소스 서버와 레플리카 서버 간 데이터 불일치를 발생시킬 수 있는 incident 타입의 이벤트
	 - 트랜잭션을 지원하지 않는 스토리지 엔진에 대한 이벤트
	
1. 압축된 트랜잭션 데이터는 트랜잭션의 개별 이벤트들의 내용 확인이 필요할 때 압축이 해제된다. 
	- 1 레플리카 서버에서 [[../레플리케이션 SQL 스레드|레플리케이션 SQL 스레드]]에 의해 복제된 트랜잭션이 적용될 때
	- 2 mysqlbinlog를 사용해 트랜잭션을 재실행할 때
	- 3 show binlog events 혹은 show relaylog events 구문이 사용될 때
2. mysqlbinlog를 통해 압축된 트랜잭션 데이터에 대해  압축된 크기와 압축도지 않은 크기를 나태는 설명과 사용된 압축 알고리즘을 확인할 수 있다.
3. 사용자는 Performace 스키마를 통해 압축된 트랜잭션들의 통계 정보와 압축 성능을 확인할 수 있다. 
	 - Performace 스키마의 `binary_log_transaction_compression_stats` 테이블에 바이너리 로그와 릴레이 로그에 기록된 트랜잭션들에 대한 압축 통계 정보가 저장
	 - 레플리카 서버에서 바이너리 로그 및 `log_slave_updates` 설정이 활성화돼 있으면 릴레이 로그 및 바이너리 로그에 대한 통계 정보도 함께 표시

```
SELECT * FROM performance_schema.binary_log_transaction_compression_stats \G
```

![[Pasted image 20240416115710.png]]

- 테이블에는 로그 파일 종류와 압축 여부별로 통계 정보가 나눠져 있다.
- LOG_TYPE 컬럼을 통해 로그 파일 종류 식별
- COMPRESSION_TYPE 컬럼을 통해 압축 여부 및 압축에 사용된 알고리즘 식별
- 각 통계 정보에서는 통계 정보가 수집되기 시작한 시점부터 지금까지 기록된 트랜잭션 수
- 크기 전체적인 압축률 및 전체적인 압축률
- 첫 번째로 기록된 트랜잭션과 마지막으로 기록된 트랜잭션에 대한 정보가 들어가 있다.


압축 성능과 관련해서 트랜잭션의 압축 및 해제에 소요된 시간을 확인하기 위해서는![[Pasted image 20240416115953.png]]
위 쿼리를 통해 설정을 변경해야 함


### 성능 비교
![[Pasted image 20240416120119.png]]
- 위 그림은 바이너리 로그 트랜잭션 압축 기능을 활성화 했을 때 바이너리 로그 파일의 크기가 어느 정도 줄어드는지 테스트 한 결과
- 기본 압축(level 3) 사용
- 두 경우 모두 압축을 적용한 후 50%정도 바이너리 로그 파일의 크기가 줄어듬